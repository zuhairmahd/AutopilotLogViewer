# Bug Fixes - October 31, 2025

## Issues Fixed

### 1. Screen Reader Column Position Not Updating After Rearrangement

**Issue**: When columns were rearranged (e.g., moving Timestamp column twice to the right), the screen reader would still announce the old column position (e.g., "column 1") even though the column was visually in the correct position.

**Root Cause**: The `AccessibleDataGrid.GetCell()` method was using the column's `DisplayIndex` property to look up cells in the `DataGridCellsPresenter`. However, the cell presenter's container index is based on the column's position in the `Columns` collection, not its `DisplayIndex`. This caused a mismatch when columns were reordered.

**Solution**: 
- Modified `AccessibleDataGrid.GetCell()` to accept a `DataGridColumn` parameter instead of an `int displayIndex`
- Changed the method to find the cell using the column's index in the `Columns` collection: `int columnIndex = Columns.IndexOf(column)`
- This ensures the correct cell is retrieved regardless of the column's `DisplayIndex`

**Files Modified**:
- `src/Autopilot.LogViewer.UI/Controls/AccessibleDataGrid.cs`
  - Changed `GetCell()` signature from `GetCell(DataGridRow row, int displayIndex)` to `GetCell(DataGridRow row, DataGridColumn column)`
  - Updated all calls to `GetCell()` in `BuildRowAccessibleName()` to pass the column object instead of its DisplayIndex

**Testing**:
- Build successful with no errors
- Screen readers should now correctly announce column positions after rearrangement
- The accessible name string is built in correct display order

---

### 2. Opening Log Files Spawned New Windows

**Issue**: When opening a log file (either from the File menu, recent files, or double-clicking a file), the application would spawn a new window instead of reusing the existing window.

**Root Cause**: The `App.xaml.cs` `OnStartup()` method always created a new `MainWindow` instance without checking if one already existed. This caused multiple windows to appear when files were opened.

**Solution**: 
- Modified `App.xaml.cs` to check for existing `MainWindow` instances using `Windows.OfType<Views.MainWindow>().FirstOrDefault()`
- If a window exists, reuse it by:
  - Setting the `FilePath` property on its `MainViewModel`
  - Calling `Activate()` to bring the window to the foreground
- Only create a new window if none exists
- Added `using System.Linq;` for the LINQ query

**Files Modified**:
- `src/Autopilot.LogViewer.UI/App.xaml.cs`
  - Added logic to detect and reuse existing windows
  - Ensured single-instance behavior for file opening

**Testing**:
- Build successful with no errors
- Opening files should now reuse the existing window
- The window should activate and come to the foreground
- Recent files menu should work correctly

---

## Technical Details

### Screen Reader Fix

The issue was in how WPF's `DataGrid` organizes cells internally:

1. **Columns Collection**: A fixed list of columns in their declared order (index 0, 1, 2, etc.)
2. **DisplayIndex**: A visual ordering property that determines where columns appear on screen
3. **Cell Presenter**: Organizes cells by their Columns collection index, NOT by DisplayIndex

When a column is moved:
- Its `DisplayIndex` changes (e.g., from 0 to 2)
- Its position in the `Columns` collection stays the same (still index 0)
- The cell presenter still uses the Columns collection index

The fix ensures we use the correct mapping: `Column object → Columns.IndexOf(column) → Cell`

### Multiple Windows Fix

The fix implements a single-instance pattern for file opening:

```csharp
// Check if window already exists
var existingWindow = Windows.OfType<Views.MainWindow>().FirstOrDefault();
if (existingWindow != null)
{
    // Reuse existing window
    existingWindow.DataContext.FilePath = filePath;
    existingWindow.Activate();
}
else
{
    // Create new window only if none exists
    var mainWindow = new Views.MainWindow();
    // ... set up and show
}
```

This pattern is common in WPF applications where only one instance should be visible at a time.

---

## Testing Checklist

- [x] Build completes without errors or warnings
- [x] Solution builds successfully (274.1 KB output)
- [ ] Screen reader correctly announces column positions after rearrangement
  - [ ] Move Timestamp column right twice
  - [ ] Verify screen reader announces correct position (e.g., "column 3")
  - [ ] Navigate through rows and verify column order in accessible name
- [ ] Opening files reuses existing window
  - [ ] Open a file from File → Open
  - [ ] Open another file from File → Open Recent
  - [ ] Double-click a log file in Explorer
  - [ ] Verify only one window remains open
  - [ ] Verify window activates and shows new file content
- [ ] Column rearrangement still works correctly
  - [ ] Right-click column header and move left/right
  - [ ] Use Ctrl+Shift+Left/Right keyboard shortcuts
  - [ ] Verify Save Column Layout persists changes
  - [ ] Verify Reset Column Layout restores defaults

---

## Build Information

- **Build Date**: October 31, 2025
- **Configuration**: Release
- **Framework**: net9.0-windows
- **Output Size**: 274.1 KB (12 files)
- **Build Status**: ✅ SUCCESS
- **Warnings**: 0
- **Errors**: 0

---

## Related Documentation

- [Column Rearrangement User Guide](COLUMN_REARRANGEMENT.md)
- [Column Rearrangement Implementation](COLUMN_REARRANGEMENT_IMPLEMENTATION.md)
- [Previous Bug Fixes (October 30)](BUG_FIXES_2025-10-30.md)
