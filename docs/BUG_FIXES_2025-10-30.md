# Bug Fixes and Enhancements - Column Rearrangement

## Date: October 30, 2025

## Issues Fixed

### 1. ✅ Reset Column Layout Bug
**Problem**: Clicking "Reset Column Layout" did not actually reset the DataGrid columns to their original positions.

**Root Cause**: 
- The ViewModel's `ResetColumnLayout()` method only updated internal state but didn't communicate with the View
- The DataGrid's DisplayIndex properties were not being reset
- No event mechanism existed to notify the View of the reset

**Solution**:
- Added `ColumnLayoutReset` event to MainViewModel
- Updated MainWindow.xaml.cs to subscribe to this event
- Implemented `ResetDataGridColumns()` method to directly reset column DisplayIndex
- Ensured settings are saved after reset so they persist

**Files Modified**:
- `ViewModels\MainViewModel.cs`: Added event and improved reset logic
- `Views\MainWindow.xaml.cs`: Added event handler and column reset logic

**Testing**:
1. Rearrange columns using Move Left/Right
2. Click View > Reset Column Layout
3. Verify columns return to: Timestamp, Level, Module, Thread, Context, Message
4. Restart application - columns should remain in default order

### 2. ✅ Recent Files Feature
**Enhancement**: Added "Open Recent" submenu to remember the last 10 opened log files.

**Implementation**:
- Added recent files persistence in `ColumnSettings.cs`
- Files stored in: `%APPDATA%\AutopilotLogViewer\RecentFiles.json`
- Added `RecentFiles` ObservableCollection to MainViewModel
- Added `OpenRecentFileCommand` for opening files from the list
- Updated File menu to show recent files submenu

**Features**:
- Shows up to 10 most recently opened files
- Most recent file appears at the top
- Files are added/moved to top when opened
- Non-existent files are automatically removed from list
- Menu item disabled when no recent files exist
- Recent files persist across application sessions
- Displays full file path in tooltip

**Files Modified**:
- `Helpers\ColumnSettings.cs`: Added SaveRecentFiles() and LoadRecentFiles()
- `ViewModels\MainViewModel.cs`: Added recent files tracking and commands
- `Views\MainWindow.xaml`: Added "Open Recent" menu with dynamic items
- `Views\MainWindow.xaml.cs`: Added Linq reference

**Testing**:
1. Open several different log files
2. Check File > Open Recent shows them in reverse chronological order
3. Click a recent file to open it
4. Verify it moves to the top of the list
5. Restart application - recent files should still be there
6. Try to open a deleted file - it should be removed from the list

## Technical Details

### Reset Column Layout Fix

**Before**:
```csharp
private void ResetColumnLayout()
{
    // Only updated ViewModel state
    _columnDisplayIndices.Clear();
    foreach (var setting in defaults)
    {
        _columnDisplayIndices[setting.Header] = setting.DisplayIndex;
    }
    // DataGrid never received the reset
}
```

**After**:
```csharp
private void ResetColumnLayout()
{
    // Update ViewModel state
    _columnDisplayIndices.Clear();
    foreach (var setting in defaults)
    {
        _columnDisplayIndices[setting.Header] = setting.DisplayIndex;
    }
    
    // Save the reset layout
    ColumnSettings.Save(defaults);
    
    // Trigger event to notify View
    ColumnLayoutReset?.Invoke(this, EventArgs.Empty);
    
    StatusText = "Column layout reset to defaults";
}
```

**View Handler**:
```csharp
private void OnColumnLayoutReset(object? sender, EventArgs e)
{
    ResetDataGridColumns();
}

private void ResetDataGridColumns()
{
    var defaults = Helpers.ColumnSettings.GetDefaults();
    foreach (var setting in defaults)
    {
        var column = LogDataGrid.Columns.FirstOrDefault(c => 
            c.Header?.ToString() == setting.Header);
        if (column != null)
        {
            column.DisplayIndex = setting.DisplayIndex;
        }
    }
}
```

### Recent Files Implementation

**Data Model**:
```json
[
  "C:\\Logs\\Autopilot_2025-10-30.log",
  "C:\\Logs\\Autopilot_2025-10-29.log",
  "C:\\Temp\\test.log"
]
```

**ViewModel Properties**:
```csharp
private const int MaxRecentFiles = 10;
private ObservableCollection<string> _recentFiles = new();

public ObservableCollection<string> RecentFiles
{
    get => _recentFiles;
    private set => SetProperty(ref _recentFiles, value);
}

public ICommand OpenRecentFileCommand => 
    new RelayCommand(param => OpenRecentFile(param as string));
```

**XAML Binding**:
```xml
<MenuItem Header="Open _Recent"
          ItemsSource="{Binding RecentFiles}">
    <MenuItem.ItemContainerStyle>
        <Style TargetType="MenuItem">
            <Setter Property="Header" Value="{Binding}"/>
            <Setter Property="Command" 
                    Value="{Binding DataContext.OpenRecentFileCommand, 
                            RelativeSource={RelativeSource AncestorType=Window}}"/>
            <Setter Property="CommandParameter" Value="{Binding}"/>
        </Style>
    </MenuItem.ItemContainerStyle>
</MenuItem>
```

## Benefits

### Reset Column Layout Fix
1. **User Experience**: Users can now reliably reset their column layout
2. **Predictability**: Behavior matches user expectations
3. **Persistence**: Reset layout is properly saved and maintained

### Recent Files Feature
1. **Productivity**: Quick access to frequently used log files
2. **Convenience**: No need to navigate file system repeatedly
3. **User-Friendly**: Common feature expected in modern applications
4. **Accessibility**: Keyboard accessible via File menu
5. **Smart Cleanup**: Automatically removes non-existent files

## Backward Compatibility

- Existing column settings are preserved
- If RecentFiles.json doesn't exist, feature works with empty list
- All changes are additive - no breaking changes to existing functionality

## Future Enhancements

### Recent Files
- [ ] Add "Clear Recent Files" menu option
- [ ] Show file size and last modified date in submenu
- [ ] Add keyboard shortcuts (Ctrl+1 through Ctrl+9) for first 9 files
- [ ] Group recent files by folder
- [ ] Pin favorite files to keep them at top

### Column Layout
- [ ] Add "Save Layout As..." to create named presets
- [ ] Quick switch between saved layouts
- [ ] Export/import layout configurations

## Testing Checklist

- [x] Build completes successfully
- [ ] Reset Column Layout restores default order
- [ ] Reset persists after application restart
- [ ] Recent files menu populates after opening files
- [ ] Most recent file appears at top
- [ ] Opening recent file moves it to top
- [ ] Non-existent files removed from list
- [ ] Menu disabled when no recent files
- [ ] Recent files persist across sessions
- [ ] Maximum of 10 files maintained
- [ ] Tooltips show full file paths
- [ ] Screen readers announce menu items correctly
